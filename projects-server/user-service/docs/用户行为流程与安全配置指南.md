# PromptFlow 用户行为流程与安全配置指南

## 概述

本文档详细描述了PromptFlow系统的用户行为流程，基于这些流程来确定哪些接口需要放行，哪些需要认证，从而指导网关和业务服务的安全配置。

## 1. 用户行为流程图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   未认证用户    │    │   网关服务      │    │   业务服务      │
│                 │    │   (Gateway)     │    │   (Services)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │ 1. 访问认证接口       │                       │
         │───────────────────────▶                       │
         │                       │                       │
         │                       │ 2. 路由到用户服务     │
         │                       │───────────────────────▶
         │                       │                       │
         │                       │                       │ 3. 处理认证逻辑
         │                       │                       │◀────────────────
         │                       │                       │
         │ 4. 返回用户信息       │                       │
         │◀──────────────────────│                       │
         │                       │                       │
         │ 5. 创建会话           │                       │
         │───────────────────────▶                       │
         │                       │                       │
         │                       │ 6. 路由到用户服务     │
         │                       │───────────────────────▶
         │                       │                       │
         │                       │                       │ 7. 生成Token
         │                       │                       │◀────────────────
         │                       │                       │
         │ 8. 返回Token          │                       │
         │◀──────────────────────│                       │
         │                       │                       │
         │ 9. 使用Token访问业务   │                       │
         │───────────────────────▶                       │
         │                       │                       │
         │                       │ 10. 验证Token并路由   │
         │                       │───────────────────────▶
         │                       │                       │
         │                       │                       │ 11. 处理业务逻辑
         │                       │                       │◀────────────────
         │                       │                       │
         │ 12. 返回业务数据      │                       │
         │◀──────────────────────│                       │
```

## 2. 用户行为场景分析

### 2.1 场景一：新用户注册流程

**行为序列**：
1. 访问注册页面
2. 填写注册信息
3. 提交注册请求
4. 自动登录
5. 创建会话
6. 进入主页面

**涉及的接口**：
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 自动登录
- `POST /api/sessions` - 创建会话

**安全要求**：
- ✅ 网关放行：所有认证相关接口
- ✅ 业务服务：放行认证接口，保护其他接口

### 2.2 场景二：已注册用户登录流程

**行为序列**：
1. 访问登录页面
2. 输入凭据
3. 提交登录请求
4. 创建会话
5. 进入主页面

**涉及的接口**：
- `POST /api/auth/login` - 用户登录
- `POST /api/sessions` - 创建会话

**安全要求**：
- ✅ 网关放行：认证接口
- ✅ 业务服务：放行认证接口

### 2.3 场景三：用户使用应用

**行为序列**：
1. 访问Prompt列表
2. 创建新Prompt
3. 编辑Prompt
4. 收藏Prompt
5. 删除Prompt

**涉及的接口**：
- `GET /api/prompts` - 获取Prompt列表
- `POST /api/prompts` - 创建Prompt
- `PUT /api/prompts/{id}` - 更新Prompt
- `POST /api/prompts/{id}/favorite` - 收藏Prompt
- `DELETE /api/prompts/{id}` - 删除Prompt

**安全要求**：
- ❌ 网关认证：需要Token
- ❌ 业务服务认证：需要Token

### 2.4 场景四：会员功能使用

**行为序列**：
1. 查看会员信息
2. 升级会员
3. 使用高级功能

**涉及的接口**：
- `GET /api/membership` - 获取会员信息
- `POST /api/membership/upgrade` - 升级会员
- `GET /api/membership/check-access/{feature}` - 检查功能权限

**安全要求**：
- ❌ 网关认证：需要Token
- ❌ 业务服务认证：需要Token

## 3. 接口安全分类

### 3.1 公开接口（无需认证）

| 接口路径 | 方法 | 描述 | 网关放行 | 业务服务放行 |
|---------|------|------|----------|-------------|
| `/api/auth/register` | POST | 用户注册 | ✅ | ✅ |
| `/api/auth/login` | POST | 用户登录 | ✅ | ✅ |
| `/api/sessions` | POST | 创建会话 | ✅ | ✅ |
| `/api/sessions/refresh` | POST | 刷新Token | ✅ | ✅ |
| `/actuator/**` | GET | 健康检查 | ✅ | ✅ |
| `/v3/api-docs/**` | GET | API文档 | ✅ | ✅ |
| `/swagger-ui/**` | GET | Swagger UI | ✅ | ✅ |

### 3.2 受保护接口（需要认证）

| 接口路径 | 方法 | 描述 | 网关认证 | 业务服务认证 |
|---------|------|------|----------|-------------|
| `/api/users/**` | 所有 | 用户管理 | ❌ | ❌ |
| `/api/prompts/**` | 所有 | Prompt管理 | ❌ | ❌ |
| `/api/tags/**` | 所有 | 标签管理 | ❌ | ❌ |
| `/api/folders/**` | 所有 | 文件夹管理 | ❌ | ❌ |
| `/api/shares/**` | 所有 | 分享管理 | ❌ | ❌ |
| `/api/membership/**` | 所有 | 会员管理 | ❌ | ❌ |
| `/api/subscriptions/**` | 所有 | 订阅管理 | ❌ | ❌ |
| `/api/orders/**` | 所有 | 订单管理 | ❌ | ❌ |
| `/api/payments/**` | 所有 | 支付管理 | ❌ | ❌ |

### 3.3 特殊接口

| 接口路径 | 方法 | 描述 | 安全要求 |
|---------|------|------|----------|
| `/api/prompts/public` | GET | 公开Prompt列表 | ✅ 网关放行，业务服务放行 |
| `/api/sessions/others` | DELETE | 失效其他会话 | ❌ 需要认证 |

## 4. 安全配置建议

### 4.1 网关服务安全配置（JWT Token方案）

```kotlin
@Bean
fun securityWebFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http
        .csrf { csrf -> csrf.disable() }
        .cors { cors -> cors.configurationSource(corsConfigurationSource()) }
        .authorizeExchange { exchanges ->
            exchanges
                // 所有接口都放行，由JWT过滤器进行认证
                .anyExchange().permitAll()
        }
        .build()
}
```

**JWT过滤器配置**：
```kotlin
@Component
class JwtAuthenticationFilter(
    private val jwtUtils: JwtUtils
) : AbstractGatewayFilterFactory<JwtAuthenticationFilter.Config>(Config::class.java) {
    
    override fun apply(config: Config): GatewayFilter {
        return GatewayFilter { exchange: ServerWebExchange, chain: GatewayFilterChain ->
            // JWT Token验证逻辑
            // 公开接口自动放行
            // 受保护接口验证Bearer Token
            // 验证成功后传递用户信息给下游服务
        }
    }
}
```

### 4.2 业务服务安全配置（信任网关方案）

```kotlin
@Bean
fun filterChain(http: HttpSecurity): SecurityFilterChain {
    http
        .cors { cors -> cors.configurationSource(corsConfigurationSource()) }
        .csrf { csrf -> csrf.disable() }
        .sessionManagement { session -> 
            session.sessionCreationPolicy(SessionCreationPolicy.STATELESS) 
        }
        .authorizeHttpRequests { auth ->
            auth
                // 公开接口
                .requestMatchers(
                    "/auth/**",          // 认证接口
                    "/sessions/**",      // 会话接口
                    "/actuator/**",      // 健康检查
                    "/v3/api-docs/**",   // API文档
                    "/swagger-ui/**"     // Swagger UI
                ).permitAll()
                // 所有其他接口都需要认证
                .anyRequest().authenticated()
        }
    
    return http.build()
}
```

**用户信息提取**：
业务服务从网关传递的请求头中获取用户信息：
- `X-User-ID`: 用户ID
- `X-Username`: 用户名
- `X-Email`: 邮箱
- `X-Roles`: 用户角色
- `X-Session-ID`: 会话ID
- `X-User-Type`: 用户类型

## 5. 安全策略总结

### 5.1 JWT Token架构优势

**从UUID Token到JWT Token的改进**：
- **性能优化**：JWT无状态验证减少数据库查询
- **安全性**：JWT签名防止Token篡改
- **可扩展性**：Token中携带用户信息，便于微服务间通信
- **标准化**：使用行业标准的JWT Token
- **易于管理**：支持多设备会话管理和Token失效

### 5.2 网关层安全策略
- **职责**：请求路由、限流、JWT Token验证
- **放行规则**：认证相关接口、健康检查、文档接口
- **认证要求**：其他所有接口都需要JWT Token认证
- **用户信息传递**：验证成功后通过请求头传递用户信息给下游服务

### 5.3 业务层安全策略
- **职责**：业务逻辑处理、细粒度权限控制
- **放行规则**：认证接口、会话接口、健康检查
- **认证要求**：业务接口都需要认证（信任网关传递的用户信息）
- **用户信息获取**：从请求头中提取网关传递的用户信息

### 5.4 数据层安全策略
- **职责**：数据存储和访问控制
- **要求**：所有数据访问都需要经过业务层验证
- **会话管理**：存储会话信息用于Token失效控制

## 6. 实施建议

### 6.1 分阶段实施
1. **第一阶段**：实现网关基础认证
2. **第二阶段**：实现业务服务认证
3. **第三阶段**：实现细粒度权限控制

### 6.2 测试验证
- 验证公开接口无需认证即可访问
- 验证受保护接口需要Token认证
- 验证Token过期和刷新机制

### 6.3 监控和日志
- 记录认证成功/失败日志
- 监控异常访问模式
- 定期审计安全配置

---

**文档版本**: 1.0  
**最后更新**: 2025年10月  
**维护者**: PromptFlow安全团队
