# 网关路由问题排查经验总结

## 问题概述
**时间**: 2025-10-31  
**问题**: 网关转发请求到用户服务时返回403错误，用户服务未收到任何请求

## 问题原因分析

### 1. 网关配置协调问题
- **context-path配置**: 用户服务配置了 `context-path: /api`
- **requestMatchers配置**: 安全配置中的路径匹配需要与context-path协调
- **StripPrefix配置**: 网关路由中的路径前缀处理需要与context-path配合

### 2. 路径匹配协调规则
```
网关请求路径: /api/auth/register
↓
网关路由匹配: Path=/api/auth/**
↓
StripPrefix=1: 去掉/api前缀 → /auth/register
↓
转发到用户服务: /auth/register
↓
用户服务context-path: /api
↓
用户服务实际路径: /api/auth/register
↓
安全配置路径匹配: /auth/** (基于context-path之后的路径)
```

### 3. Redis和限流配置问题
- 使用 `RequestRateLimiter` 必须配置 `KeyResolver`
- 缺少Redis键解析器会导致限流器阻止所有请求
- 限流器配置需要与Redis服务协调

## 排查经验总结

### 1. 调试方法
- **启用DEBUG日志**: 必须打开网关和负载均衡器的DEBUG日志
- **分层排查**: 从网关→服务发现→用户服务逐层排查
- **直接测试**: 绕过网关直接测试用户服务确认问题范围

### 2. 关键排查步骤
1. 确认网关路由匹配成功
2. 检查服务发现状态
3. 验证网关安全配置
4. 检查限流器配置
5. 直接测试用户服务
6. 分析路径匹配协调

### 3. 避免的误区
- 不要仅依赖AI猜测，必须结合实际日志分析
- 注意context-path对路径匹配的影响
- 理解Spring Security路径匹配是基于context-path之后的路径

## 解决方案

### 1. 网关路由配置
```yaml
# 用户服务路由
- id: user-service
  uri: lb://user-service
  predicates:
    - Path=/api/users/**,/api/auth/**,/api/sessions/**
  filters:
    - StripPrefix=1  # 去掉/api前缀
```

### 2. 用户服务安全配置
```kotlin
.requestMatchers(
    "/auth/**",  // 基于context-path之后的路径
    "/actuator/**",
    "/v3/api-docs/**",
    "/swagger-ui/**",
    "/swagger-ui.html"
).permitAll()
```

### 3. 网关限流器配置
```kotlin
@Bean
fun keyResolver(): KeyResolver {
    return KeyResolver { exchange ->
        Mono.just(exchange.request.remoteAddress?.address?.hostAddress ?: "unknown")
    }
}
```

## 经验教训

1. **配置协调**: 网关路由、context-path、安全配置必须协调一致
2. **调试优先**: 遇到问题第一时间启用DEBUG日志
3. **分层测试**: 从简单到复杂，逐层验证
4. **理解原理**: 理解Spring框架的路径处理机制

## 相关文件
- `projects-server/gateway-service/src/main/resources/application.yml`
- `projects-server/common-lib/src/main/kotlin/com/promptflow/config/SecurityConfig.kt`
- `projects-server/gateway-service/src/main/kotlin/com/promptflow/gateway/config/GatewaySecurityConfig.kt`
