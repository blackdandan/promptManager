# 文件夹相关设计

## 当前问题

### 1. 文件无法拖动到文件夹改变文件夹归属
- **问题描述**: 用户无法通过拖拽方式将Prompt移动到目标文件夹
- **影响**: 用户体验不佳，无法快速重新组织Prompt

### 2. 文件变更文件夹后计数未更新
- **问题描述**: Prompt移动到新文件夹后，原文件夹和目标文件夹的计数未正确更新
- **影响**: 文件夹显示的文件数量不准确

### 3. 文件夹拖动限制问题
- **问题描述**: 
  - 文件夹拖动不支持跨级别移动
  - 拖动文件夹时未包含其子文件和子文件夹
- **影响**: 无法灵活重组文件夹结构

### 4. 文件夹层级限制问题
- **问题描述**: 创建超过3层的文件夹时未进行限制提示
- **影响**: 可能导致用户创建过深的文件夹结构

## 设计方案

### 1. Prompt拖拽移动功能

#### 前端实现
- 在MainScreen.tsx中为每个Prompt项添加拖拽支持
- 实现拖拽事件处理：
  - `onDragStart`: 记录被拖拽的Prompt信息
  - `onDragOver`: 阻止默认行为，显示拖拽目标效果
 - `onDrop`: 处理Prompt移动逻辑

#### 后端API
- 扩展现有的Prompt更新API，支持folderId字段更新
- 在更新folderId时，自动更新原文件夹和目标文件夹的计数

#### 数据一致性
- 使用事务确保计数更新的原子性
- 移动Prompt时，原文件夹计数-1，目标文件夹计数+1

### 2. 文件夹计数实时更新

#### 计数更新时机
- **Prompt创建**: 目标文件夹计数+1
- **Prompt删除**: 原文件夹计数-1  
- **Prompt移动**: 原文件夹计数-1，目标文件夹计数+1
- **文件夹删除**: 递归更新所有子文件夹和其包含的Prompt计数

#### 前端优化
- 实现计数缓存机制
- 使用WebSocket或SSE实时接收计数更新
- 避免频繁的API调用

### 3. 文件夹拖拽重组功能

#### 拖拽层级支持
- 支持跨级别拖拽移动
- 拖拽时显示层级提示（如缩进线、放置位置指示器）
- 验证目标位置的层级深度（不超过3层）

#### 递归移动逻辑
- 拖拽文件夹时，递归移动其所有子文件夹和Prompt
- 更新所有受影响文件夹的计数
- 保持文件夹的完整结构

#### 拖拽限制
- 实时计算目标层级深度
- 如果移动后超过3层限制，阻止拖拽操作
- 提供友好的错误提示

### 4. 文件夹层级限制

#### 创建时限制
- 在创建新文件夹前，先计算当前路径的层级深度
- 如果父文件夹层级已达2级（根目录为0级），阻止创建子文件夹
- 显示"文件夹最多支持3层，无法继续创建"的提示

#### 拖拽时限制
- 在拖拽操作前验证目标位置的层级
- 如果移动后会超过3层限制，阻止操作并提示

## 技术实现细节

### 前端实现

#### Prompt拖拽组件
```typescript
// 在Prompt列表项中添加拖拽支持
<div 
  draggable
  onDragStart={handlePromptDragStart}
  onDragOver={handleDragOver}
  onDrop={handlePromptDrop}
>
```

#### 文件夹拖拽组件
```typescript
// 在文件夹节点中添加拖拽支持
<div 
  draggable
  onDragStart={handleFolderDragStart}
  onDragOver={handleFolderDragOver}
  onDrop={handleFolderDrop}
>
```

#### 拖拽状态管理
- 使用React状态管理拖拽过程中的视觉反馈
- 高亮显示有效的拖拽目标
- 显示层级深度指示器

### 后端实现

#### Prompt服务增强
```kotlin
fun movePromptToFolder(promptId: ObjectId, newFolderId: ObjectId?): Prompt {
    // 获取原文件夹信息
    val oldFolderId = getPromptById(promptId).folderId
    val prompt = updatePrompt(promptId, UpdatePromptRequest(folderId = newFolderId.toString()))
    
    // 更新文件夹计数
    if (oldFolderId != null) {
        updateFolderPromptCount(ObjectId(oldFolderId), -1)
    }
    if (newFolderId != null) {
        updateFolderPromptCount(newFolderId, +1)
    }
    
    return prompt
}
```

#### 文件夹服务增强
```kotlin
fun moveFolder(folderId: ObjectId, newParentId: ObjectId?): Folder {
    // 验证层级深度
    if (wouldExceedDepthLimit(folderId, newParentId)) {
        throw IllegalArgumentException("移动后将超过最大层级限制")
    }
    
    // 递归更新所有子文件夹的层级
    val folder = updateFolder(userId, folderId, parentId = newParentId)
    updateSubfolderCountsRecursively(folderId)
    
    return folder
}
```

## 实现优先级

### 高优先级（必须实现）
1. Prompt拖拽移动功能
2. 文件夹计数实时更新
3. 文件夹层级创建限制

### 中优先级（重要功能）
1. 文件夹跨级别拖拽
2. 文件夹递归移动
3. 拖拽时层级验证

### 低优先级（优化功能）
1. 拖拽视觉反馈优化
2. 计数缓存机制
3. 实时计数更新（WebSocket）

## 测试要点

### 功能测试
- Prompt拖拽移动功能
- 文件夹计数准确性
- 层级限制验证
- 递归移动功能

### 性能测试
- 大量Prompt时的拖拽性能
- 深层文件夹结构的操作性能
- 计数更新的响应时间

### 边界情况
- 空文件夹的拖拽
- 跨层级移动的边界验证
- 并发操作的数据一致性

## 待办列表

### 高优先级任务
- [ ] 实现Prompt拖拽移动功能（前端MainScreen组件）
- [ ] 实现后端API支持Prompt移动（PromptService）
- [ ] 实现文件夹计数实时更新逻辑
- [ ] 实现文件夹创建层级限制（最多3层）

### 中优先级任务
- [ ] 实现文件夹跨级别拖拽功能
- [ ] 实现文件夹递归移动（包含子文件夹和Prompt）
- [ ] 实现拖拽时层级深度验证
- [ ] 优化拖拽视觉反馈效果

### 低优先级任务
- [ ] 实现计数缓存机制
- [ ] 实现实时计数更新（WebSocket/SSE）
- [ ] 添加拖拽操作的错误处理和用户提示
