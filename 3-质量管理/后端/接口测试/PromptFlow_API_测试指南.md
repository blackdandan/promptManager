# PromptFlow API 测试指南

## 概述

本文档提供 PromptFlow 微服务API的完整测试指南，包括测试环境配置、测试用例说明、测试执行流程和常见问题处理。

## 测试环境配置

### 1. 环境要求
- **Postman**: 版本 10.0+
- **微服务**: 所有服务正常运行
- **数据库**: MongoDB、Redis 正常运行
- **网络**: 本地开发环境可访问

### 2. 环境变量配置

#### 导入环境配置
1. 在 Postman 中导入 `Postman环境配置.json`
2. 选择 "PromptFlow 开发环境"
3. 确认以下环境变量已正确设置：

```json
{
  "base_url": "http://localhost:8080",
  "gateway_url": "http://localhost:8080",
  "user_service_url": "http://localhost:8081",
  "membership_service_url": "http://localhost:8082",
  "business_service_url": "http://localhost:8083",
  "discovery_service_url": "http://localhost:8761"
}
```

#### 动态环境变量
测试过程中会自动设置以下变量：
- `user_id`: 用户ID
- `session_id`: 会话ID
- `bearer_token`: 访问令牌
- `refresh_token`: 刷新令牌
- `prompt_id`: Prompt ID

### 3. 导入测试集合
1. 在 Postman 中导入 `PromptFlow_API_测试集合.json`
2. 选择 "PromptFlow API 测试集合"
3. 关联到 "PromptFlow 开发环境"

## 测试用例说明

### 1. 认证服务测试

#### 1.1 用户注册
- **目的**: 验证用户注册功能
- **测试数据**: 测试用户信息
- **验证点**: 
  - 状态码 201
  - 响应包含用户信息
  - 用户ID正确生成

#### 1.2 用户登录
- **目的**: 验证用户登录功能
- **测试数据**: 已注册用户凭据
- **验证点**:
  - 状态码 200
  - 响应包含用户信息
  - 自动设置用户ID环境变量

#### 1.3 登录失败测试
- **目的**: 验证错误密码处理
- **测试数据**: 错误密码
- **验证点**:
  - 状态码 401
  - 错误码 AUTH_001

### 2. 会话管理测试

#### 2.1 创建会话
- **目的**: 验证会话创建功能
- **前置条件**: 用户已登录
- **验证点**:
  - 状态码 201
  - 响应包含会话信息
  - 自动设置会话相关环境变量

#### 2.2 获取会话列表
- **目的**: 验证会话列表查询
- **前置条件**: 用户有活跃会话
- **验证点**:
  - 状态码 200
  - 响应包含会话数组

#### 2.3 刷新Token
- **目的**: 验证Token刷新机制
- **前置条件**: 有有效的refresh_token
- **验证点**:
  - 状态码 200
  - 返回新的访问令牌
  - 更新环境变量

### 3. 业务服务测试

#### 3.1 Prompt管理完整流程
1. **创建Prompt**
   - 验证创建功能
   - 设置prompt_id环境变量

2. **获取Prompt列表**
   - 验证分页查询
   - 验证搜索和筛选

3. **获取单个Prompt**
   - 验证详情查询
   - 验证权限控制

4. **更新Prompt**
   - 验证更新功能
   - 验证字段更新

5. **切换收藏状态**
   - 验证收藏功能
   - 验证状态切换

6. **删除Prompt**
   - 验证删除功能
   - 验证权限控制

#### 3.2 标签管理
- **获取用户标签列表**
- **验证标签聚合功能**

#### 3.3 统计信息
- **获取用户统计**
- **验证数据准确性**

### 4. 会员服务测试

#### 4.1 会员管理
- **创建免费会员**
- **获取会员信息**
- **验证会员状态**

#### 4.2 功能权限
- **检查功能访问权限**
- **验证权限控制逻辑**

#### 4.3 使用统计
- **获取使用统计**
- **验证统计准确性**

## 测试执行流程

### 1. 准备工作
1. 启动所有微服务
2. 确认数据库连接正常
3. 导入Postman环境和集合

### 2. 测试执行顺序
建议按以下顺序执行测试：

```bash
# 1. 认证服务
用户注册 → 用户登录 → 登录失败测试

# 2. 会话管理
创建会话 → 获取会话列表 → 刷新Token

# 3. 业务服务
创建Prompt → 获取Prompt列表 → 获取单个Prompt → 
更新Prompt → 切换收藏状态 → 获取标签列表 → 
获取统计信息 → 删除Prompt

# 4. 会员服务
创建免费会员 → 获取会员信息 → 
检查功能访问权限 → 获取使用统计
```

### 3. 批量执行
可以使用 Postman Runner 批量执行测试集合：

1. 打开 Postman Runner
2. 选择 "PromptFlow API 测试集合"
3. 选择 "PromptFlow 开发环境"
4. 设置迭代次数和数据文件（可选）
5. 开始执行测试

## 测试验证要点

### 1. 响应格式验证
- 统一响应格式：`{code, message, data}`
- 错误响应格式：`{code, message, data: null}`
- 状态码符合预期

### 2. 数据完整性验证
- 必填字段存在
- 数据类型正确
- 数据关系正确

### 3. 业务逻辑验证
- 权限控制正确
- 状态流转正确
- 数据一致性

### 4. 性能验证
- 响应时间 < 5000ms
- 并发处理能力
- 资源使用情况

## 常见问题处理

### 1. 连接问题
**问题**: 无法连接到服务
**解决**:
- 确认服务是否启动
- 检查端口配置
- 验证网络连接

### 2. 认证失败
**问题**: Token无效或过期
**解决**:
- 重新执行登录流程
- 检查Token格式
- 验证认证配置

### 3. 数据问题
**问题**: 测试数据不一致
**解决**:
- 清理测试数据
- 重新创建测试用户
- 检查数据库状态

### 4. 权限问题
**问题**: 无权限访问接口
**解决**:
- 验证用户权限
- 检查会话状态
- 确认接口权限配置

## 测试报告

### 1. 测试结果记录
- 记录每次测试的执行结果
- 标记失败的测试用例
- 记录错误信息和解决方案

### 2. 性能指标
- 平均响应时间
- 成功率
- 错误率

### 3. 问题跟踪
- 创建问题清单
- 跟踪问题解决进度
- 验证修复效果

## 自动化测试

### 1. Newman 命令行执行
```bash
# 安装 Newman
npm install -g newman

# 执行测试集合
newman run "PromptFlow_API_测试集合.json" \
  -e "Postman环境配置.json" \
  -r htmlextra

# 生成HTML报告
newman run "PromptFlow_API_测试集合.json" \
  -e "Postman环境配置.json" \
  -r htmlextra --reporter-htmlextra-export report.html
```

### 2. CI/CD 集成
```yaml
# GitHub Actions 示例
- name: API Tests
  run: |
    newman run "PromptFlow_API_测试集合.json" \
      -e "Postman环境配置.json" \
      --suppress-exit-code
```

## 维护说明

### 1. 定期更新
- 根据API变更更新测试用例
- 验证新的接口功能
- 更新测试数据

### 2. 环境管理
- 维护不同环境的配置
- 管理测试数据隔离
- 定期清理测试数据

### 3. 文档同步
- 保持测试文档与API文档同步
- 更新测试用例说明
- 记录测试经验

---

**文档版本**: 1.0  
**最后更新**: 2025年10月  
**维护者**: PromptFlow测试团队
