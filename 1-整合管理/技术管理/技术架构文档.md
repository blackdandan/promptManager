# 技术架构文档

## 1. 系统架构概述

### 1.1 架构目标
- **简洁性**：避免过度设计，专注核心功能
- **可扩展性**：支持后续功能迭代
- **多端同步**：Web端和Android端数据一致性
- **性能优先**：快速响应，低延迟

### 1.2 架构原则
- **前后端分离**：清晰的职责划分
- **RESTful API**：标准化的接口设计
- **本地优先**：支持离线使用
- **渐进增强**：从MVP开始逐步完善

## 2. 微服务架构设计

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│    Web前端      │    │    Android端    │    │     API网关     │
│                 │    │                 │    │                 │
│ • React/Vue     │    │ • Kotlin        │    │ • 路由转发      │
│ • 响应式设计    │    │ • Jetpack       │    │ • 认证鉴权      │
│ • PWA支持       │    │ • Room数据库   │    │ • 限流熔断      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                  ┌─────────────────────────────┐
                  │                             │
          ┌─────────────┐               ┌─────────────┐
          │  用户服务   │               │  业务服务   │
          │             │               │             │
          │ • 用户认证  │               │ • Prompt管理│
          │ • 权限管理  │               │ • 标签管理  │
          │ • 用户信息  │               │ • 数据同步  │
          │ • MongoDB  │               │ • 分享服务  │
          └─────────────┘               │ • MongoDB  │
                  │                     └─────────────┘
                  │                             │
                  └─────────────────────────────┘
                                 │
                         ┌─────────────────┐
                         │   数据同步层    │
                         │                 │
                         │ • 消息队列      │
                         │ • 增量同步      │
                         │ • 冲突解决      │
                         └─────────────────┘
```

## 3. 前端架构

### 3.1 Web端技术栈
- **框架**：Vue 3 + TypeScript
- **状态管理**：Pinia
- **UI组件**：Element Plus
- **路由**：Vue Router
- **构建工具**：Vite
- **包管理**：npm/yarn

### 3.2 Android端技术栈
- **语言**：Kotlin
- **架构**：MVVM + Repository模式
- **UI框架**：Jetpack Compose
- **数据库**：Room
- **网络**：Retrofit + OkHttp
- **依赖注入**：Hilt/Dagger

## 4. 微服务架构详细设计

### 4.1 服务拆分方案

#### 4.1.1 用户服务 (User Service)
**职责范围：**
- 用户注册、登录、认证
- 用户信息管理
- 权限管理和角色控制
- 会话管理和Token发放

**技术栈：**
- **语言**：Kotlin
- **框架**：Spring Boot 3.x
- **数据库**：MongoDB（用户数据）
- **缓存**：Redis（会话缓存）
- **认证**：Spring Security + JWT
- **构建工具**：Gradle

#### 4.1.2 业务服务 (Business Service)
**职责范围：**
- Prompt的增删改查管理
- 标签管理和分类
- 数据同步处理
- 分享服务管理

**技术栈：**
- **语言**：Kotlin
- **框架**：Spring Boot 3.x
- **数据库**：MongoDB（业务数据）
- **消息队列**：RabbitMQ（异步任务）
- **缓存**：Redis（热点数据）
- **构建工具**：Gradle

#### 4.1.3 API网关 (API Gateway)
**职责范围：**
- 请求路由和负载均衡
- 统一认证和鉴权
- 限流和熔断保护
- API组合和聚合

**技术栈：**
- **语言**：Kotlin
- **框架**：Spring Cloud Gateway
- **服务发现**：Spring Cloud Eureka
- **配置中心**：Spring Cloud Config
- **构建工具**：Gradle

### 4.2 服务间通信

#### 4.2.1 同步通信
- **RESTful API**：服务间HTTP调用
- **gRPC**：高性能内部通信（可选）
- **服务发现**：动态服务注册和发现

#### 4.2.2 异步通信
- **消息队列**：RabbitMQ/Kafka
- **事件驱动**：基于事件的松耦合通信
- **数据同步**：通过消息队列实现数据最终一致性

### 4.3 数据管理策略

#### 4.3.1 数据库拆分
- **用户数据库**：存储用户认证和基本信息
- **业务数据库**：存储Prompt、标签等业务数据
- **共享数据库**：存储需要跨服务访问的数据

#### 4.3.2 数据一致性
- **最终一致性**：通过消息队列保证数据最终一致
- **分布式事务**：Saga模式处理跨服务事务
- **数据同步**：定期数据同步和一致性检查

### 4.4 API设计原则
- **RESTful风格**：资源导向的API设计
- **版本控制**：API版本管理
- **文档化**：Swagger/OpenAPI
- **错误处理**：统一的错误响应格式

## 5. 数据架构

### 5.1 数据库设计
```
用户表 (users)
├── id: ObjectId
├── email: String
├── password: String (加密)
├── createdAt: Date
└── lastLogin: Date

Prompt表 (prompts)
├── id: ObjectId
├── userId: ObjectId
├── title: String
├── content: String
├── tags: Array[String]
├── category: String
├── variables: Array[String]
├── useCount: Number
├── createdAt: Date
├── updatedAt: Date
└── isDeleted: Boolean

同步表 (sync_records)
├── id: ObjectId
├── userId: ObjectId
├── deviceId: String
├── lastSyncTime: Date
└── syncVersion: Number
```

### 5.2 数据同步策略
- **增量同步**：只同步变更数据
- **冲突解决**：最后修改优先
- **版本控制**：数据版本管理
- **离线支持**：本地数据持久化

## 6. 安全架构

### 6.1 认证授权
- **用户认证**：JWT token
- **密码安全**：bcrypt加密
- **会话管理**：token过期机制
- **权限控制**：基于用户的资源访问

### 6.2 数据安全
- **传输加密**：HTTPS/TLS
- **数据加密**：敏感字段加密存储
- **输入验证**：防止SQL注入和XSS攻击
- **API限流**：防止恶意请求

## 7. 部署架构

### 7.1 开发环境
- **本地开发**：Docker容器化
- **代码管理**：Git + GitHub
- **CI/CD**：GitHub Actions
- **测试环境**：独立的测试服务器

### 7.2 生产环境
- **Web端**：Vercel/Netlify
- **服务端**：AWS EC2/DigitalOcean
- **数据库**：MongoDB Atlas/自建PostgreSQL
- **CDN**：Cloudflare

## 8. 监控和日志

### 8.1 应用监控
- **性能监控**：响应时间、错误率
- **业务监控**：用户活跃度、功能使用率
- **系统监控**：CPU、内存、磁盘使用率

### 8.2 日志管理
- **访问日志**：记录所有API请求
- **错误日志**：记录系统错误和异常
- **业务日志**：记录关键业务操作
- **日志聚合**：ELK Stack/Graylog

## 9. 技术约束

### 9.1 开发约束
- **团队规模**：单人开发
- **开发周期**：8周总工期
- **技术栈**：选择成熟稳定的技术

### 9.2 性能约束
- **响应时间**：核心操作<2秒
- **并发用户**：支持1000并发
- **数据同步**：同步延迟<30秒

## 10. 技术风险

### 10.1 已识别风险
- **技术复杂度**：多端同步的技术挑战
- **性能瓶颈**：数据同步可能成为性能瓶颈
- **兼容性问题**：不同设备和浏览器的兼容性

### 10.2 应对策略
- **原型验证**：关键技术点提前验证
- **性能测试**：早期性能测试和优化
- **渐进开发**：从简单功能开始逐步复杂化

---
**文档版本**：1.0  
**编制人**：项目经理  
**编制日期**：第1周  
**下次评审**：技术实现阶段开始前
