# 用户服务设计文档

## 1. 服务概述

### 1.1 服务职责
用户服务负责整个系统的用户认证、授权和用户信息管理，支持多种登录方式。

### 1.2 核心功能
- **用户认证**：注册、登录、Token管理
- **游客登录**：匿名用户快速体验
- **三方登录**：GitHub、Google、微信等第三方登录
- **用户管理**：用户信息维护、权限控制
- **会话管理**：登录状态、Token刷新
- **安全控制**：密码加密、访问控制

### 1.3 技术栈
- **语言**：Kotlin
- **框架**：Spring Boot 3.x + Spring Security + OAuth2
- **数据库**：MongoDB + Spring Data MongoDB
- **缓存**：Redis + Spring Data Redis
- **三方登录**：Spring Security OAuth2 Client
- **构建工具**：Gradle
- **文档**：SpringDoc OpenAPI 3

## 2. 数据模型设计

### 2.1 用户实体
```kotlin
data class User(
    @Id val id: ObjectId? = null,
    val email: String? = null,           // 邮箱（可为空，用于三方登录）
    val password: String? = null,        // bcrypt加密（可为空，用于三方登录）
    val username: String? = null,
    val avatar: String? = null,
    val userType: UserType = UserType.REGISTERED, // 用户类型：注册用户、游客、三方用户
    val status: UserStatus = UserStatus.ACTIVE,
    val roles: List<String> = listOf("USER"),
    val createdAt: Instant = Instant.now(),
    val updatedAt: Instant = Instant.now(),
    val lastLogin: Instant? = null
)
```

### 2.2 三方登录关联实体
```kotlin
data class OAuthConnection(
    @Id val id: ObjectId? = null,
    val userId: ObjectId,
    val provider: OAuthProvider,         // 三方登录提供商
    val providerUserId: String,          // 三方平台的用户ID
    val accessToken: String? = null,     // 访问令牌
    val refreshToken: String? = null,    // 刷新令牌
    val expiresAt: Instant? = null,      // 令牌过期时间
    val profileData: Map<String, Any>? = null, // 三方平台返回的用户信息
    val createdAt: Instant = Instant.now(),
    val updatedAt: Instant = Instant.now()
)
```

### 2.3 游客会话实体
```kotlin
data class GuestSession(
    @Id val id: ObjectId? = null,
    val guestId: String,                 // 游客唯一标识
    val deviceId: String,                // 设备标识
    val token: String,                   // JWT token
    val expiresAt: Instant,
    val createdAt: Instant = Instant.now()
)
```

### 2.4 会话实体
```kotlin
data class UserSession(
    @Id val id: ObjectId? = null,
    val userId: ObjectId,
    val token: String,                   // JWT token
    val refreshToken: String,            // 刷新token
    val expiresAt: Instant,
    val deviceInfo: DeviceInfo,
    val createdAt: Instant = Instant.now()
)
```

### 2.5 枚举定义
```kotlin
enum class UserType {
    REGISTERED,     // 注册用户
    GUEST,          // 游客
    OAUTH           // 三方登录用户
}

enum class OAuthProvider {
    GITHUB,         // GitHub登录
    GOOGLE,         // Google登录
    WECHAT,         // 微信登录
    APPLE           // Apple登录
}

enum class UserStatus {
    ACTIVE,         // 活跃
    INACTIVE,       // 非活跃
    SUSPENDED       // 暂停
}
```

## 3. API接口设计

### 3.1 认证接口

#### 3.1.1 用户注册
**POST** `/auth/register`

**请求体：**
```json
{
  "email": "user@example.com",
  "password": "password123",
  "username": "optional_username"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "user_id",
      "email": "user@example.com",
      "username": "optional_username",
      "userType": "REGISTERED"
    },
    "token": "jwt_token"
  },
  "message": "注册成功"
}
```

#### 3.1.2 用户登录
**POST** `/auth/login`

**请求体：**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "user_id",
      "email": "user@example.com",
      "username": "optional_username"
    },
    "token": "jwt_token"
  },
  "message": "登录成功"
}
```

#### 3.1.3 游客登录
**POST** `/auth/guest`

**请求体：**
```json
{
  "deviceId": "device_identifier"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "guest": {
      "guestId": "guest_unique_id",
      "deviceId": "device_identifier"
    },
    "token": "jwt_token"
  },
  "message": "游客登录成功"
}
```

#### 3.1.4 三方登录授权
**GET** `/auth/oauth/{provider}`

**响应：** 重定向到三方登录页面

#### 3.1.5 三方登录回调
**POST** `/auth/oauth/{provider}/callback`

**请求体：**
```json
{
  "code": "authorization_code",
  "state": "state_parameter"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "user_id",
      "email": "user@example.com",
      "username": "username_from_provider",
      "avatar": "avatar_url_from_provider",
      "userType": "OAUTH"
    },
    "token": "jwt_token"
  },
  "message": "三方登录成功"
}
```

#### 3.1.6 Token刷新
**POST** `/auth/refresh`

**请求头：**
```
Authorization: Bearer {refresh_token}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "token": "new_jwt_token"
  },
  "message": "Token刷新成功"
}
```

#### 3.1.7 游客升级
**POST** `/auth/guest/upgrade`

**请求体：**
```json
{
  "email": "user@example.com",
  "password": "password123",
  "username": "optional_username"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "user_id",
      "email": "user@example.com",
      "username": "optional_username",
      "userType": "REGISTERED"
    },
    "token": "jwt_token"
  },
  "message": "游客升级成功"
}
```

### 3.2 用户管理接口

#### 3.2.1 获取用户信息
**GET** `/users/me`

**响应：**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "user_id",
      "email": "user@example.com",
      "username": "optional_username",
      "avatar": "avatar_url",
      "userType": "REGISTERED",
      "status": "ACTIVE",
      "createdAt": "2024-01-01T00:00:00Z",
      "lastLogin": "2024-01-01T00:00:00Z"
    }
  },
  "message": "获取用户信息成功"
}
```

#### 3.2.2 更新用户信息
**PUT** `/users/me`

**请求体：**
```json
{
  "username": "new_username",
  "avatar": "new_avatar_url"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "user_id",
      "email": "user@example.com",
      "username": "new_username",
      "avatar": "new_avatar_url"
    }
  },
  "message": "用户信息更新成功"
}
```

#### 3.2.3 获取三方登录关联
**GET** `/users/oauth/connections`

**响应：**
```json
{
  "success": true,
  "data": {
    "connections": [
      {
        "provider": "GITHUB",
        "providerUserId": "github_user_id",
        "createdAt": "2024-01-01T00:00:00Z"
      }
    ]
  },
  "message": "获取三方登录关联成功"
}
```

#### 3.2.4 解绑三方登录
**DELETE** `/users/oauth/{provider}`

**响应：**
```json
{
  "success": true,
  "data": null,
  "message": "三方登录解绑成功"
}
```

## 4. 服务配置

### 4.1 Spring Security配置
```kotlin
@Configuration
@EnableWebSecurity
class SecurityConfig {
    
    @Bean
    fun securityFilterChain(http: HttpSecurity): SecurityFilterChain {
        return http
            .csrf { it.disable() }
            .authorizeHttpRequests { auth ->
                auth.requestMatchers("/auth/**").permitAll()
                    .requestMatchers("/users/me").authenticated()
                    .anyRequest().authenticated()
            }
            .oauth2Login { oauth2 ->
                oauth2.loginPage("/auth/oauth/{provider}")
                    .defaultSuccessUrl("/auth/oauth/success")
                    .failureUrl("/auth/oauth/failure")
            }
            .sessionManagement { session ->
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            }
            .build()
    }
}
```

### 4.2 OAuth2配置
```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          github:
            client-id: ${GITHUB_CLIENT_ID}
            client-secret: ${GITHUB_CLIENT_SECRET}
            scope: user:email,read:user
          google:
            client-id: ${GOOGLE_CLIENT_ID}
            client-secret: ${GOOGLE_CLIENT_SECRET}
            scope: email,profile
```

### 4.3 数据库配置
```yaml
spring:
  data:
    mongodb:
      uri: mongodb://localhost:27017/user_db
      auto-index-creation: true
  redis:
    host: localhost
    port: 6379
```

## 5. 错误处理

### 5.1 错误响应格式
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述",
    "details": "详细错误信息"
  },
  "data": null
}
```

### 5.2 常见错误码
- `AUTH_001`：认证失败
- `AUTH_002`：Token过期
- `AUTH_003`：三方登录失败
- `AUTH_004`：游客升级失败
- `VALIDATION_001`：参数验证失败
- `NOT_FOUND_001`：用户不存在
- `CONFLICT_001`：邮箱已存在

## 6. 部署配置

### 6.1 Docker配置
```dockerfile
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY build/libs/user-service-*.jar app.jar
EXPOSE 8081
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 6.2 环境变量配置
```yaml
# application-docker.yml
spring:
  data:
    mongodb:
      uri: mongodb://mongo:27017/user_db
  redis:
    host: redis
    port: 6379
  security:
    oauth2:
      client:
        registration:
          github:
            client-id: ${GITHUB_CLIENT_ID}
            client-secret: ${GITHUB_CLIENT_SECRET}
          google:
            client-id: ${GOOGLE_CLIENT_ID}
            client-secret: ${GOOGLE_CLIENT_SECRET}

jwt:
  secret: ${JWT_SECRET}
  expiration: 86400000
```

---
**文档版本**：1.0  
**编制人**：项目经理  
**编制日期**：第1周  
**下次评审**：用户服务实现阶段开始前
