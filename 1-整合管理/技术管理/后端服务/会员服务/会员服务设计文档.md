# 会员服务设计文档

## 1. 服务概述

### 1.1 服务职责
会员服务负责整个系统的会员体系管理、订阅管理、支付处理和订单管理，支持多种会员等级和付费模式。

### 1.2 核心功能
- **会员体系**：会员等级、权益管理、会员状态跟踪
- **订阅管理**：套餐订阅、续费、升级、降级
- **支付处理**：多种支付方式集成、支付回调处理
- **订单管理**：订单创建、支付状态跟踪、退款处理
- **权益控制**：会员权益验证、使用限制管理
- **账单管理**：账单生成、发票管理

### 1.3 技术栈
- **语言**：Kotlin
- **框架**：Spring Boot 3.x + Spring Data MongoDB
- **数据库**：MongoDB
- **缓存**：Redis + Spring Data Redis
- **支付集成**：微信支付、支付宝、Stripe
- **消息队列**：RabbitMQ + Spring AMQP
- **构建工具**：Gradle
- **文档**：SpringDoc OpenAPI 3

## 2. 数据模型设计

### 2.1 会员实体
```kotlin
data class Membership(
    @Id val id: ObjectId? = null,
    val userId: ObjectId,                // 用户ID
    val membershipType: MembershipType = MembershipType.FREE, // 会员类型
    val level: MembershipLevel = MembershipLevel.BASIC, // 会员等级
    val benefits: List<MembershipBenefit> = emptyList(), // 会员权益
    val subscriptionId: ObjectId? = null, // 订阅ID
    val expiresAt: Instant? = null,      // 会员过期时间
    val isActive: Boolean = true,        // 是否有效
    val createdAt: Instant = Instant.now(),
    val updatedAt: Instant = Instant.now()
)
```

### 2.2 订阅实体
```kotlin
data class Subscription(
    @Id val id: ObjectId? = null,
    val userId: ObjectId,                // 用户ID
    val planId: ObjectId,                // 套餐ID
    val planType: SubscriptionPlanType,  // 套餐类型
    val status: SubscriptionStatus = SubscriptionStatus.ACTIVE, // 订阅状态
    val billingCycle: BillingCycle,      // 计费周期
    val amount: BigDecimal,              // 金额
    val currency: String = "CNY",        // 货币
    val startDate: Instant,              // 开始时间
    val endDate: Instant,                // 结束时间
    val nextBillingDate: Instant,        // 下次计费时间
    val paymentMethod: PaymentMethod? = null, // 支付方式
    val autoRenew: Boolean = true,       // 自动续费
    val createdAt: Instant = Instant.now(),
    val updatedAt: Instant = Instant.now()
)
```

### 2.3 订单实体
```kotlin
data class Order(
    @Id val id: ObjectId? = null,
    val userId: ObjectId,                // 用户ID
    val orderNumber: String,             // 订单号（唯一）
    val planId: ObjectId,                // 套餐ID
    val planType: SubscriptionPlanType,  // 套餐类型
    val amount: BigDecimal,              // 金额
    val currency: String = "CNY",        // 货币
    val status: OrderStatus = OrderStatus.PENDING, // 订单状态
    val paymentMethod: PaymentMethod,    // 支付方式
    val paymentStatus: PaymentStatus = PaymentStatus.PENDING, // 支付状态
    val paymentId: String? = null,       // 支付平台订单ID
    val expiresAt: Instant,              // 订单过期时间
    val createdAt: Instant = Instant.now(),
    val updatedAt: Instant = Instant.now()
)
```

### 2.4 套餐实体
```kotlin
data class Plan(
    @Id val id: ObjectId? = null,
    val name: String,                    // 套餐名称
    val description: String,             // 套餐描述
    val planType: SubscriptionPlanType,  // 套餐类型
    val membershipType: MembershipType,  // 会员类型
    val membershipLevel: MembershipLevel, // 会员等级
    val benefits: List<MembershipBenefit>, // 包含权益
    val amount: BigDecimal,              // 金额
    val currency: String = "CNY",        // 货币
    val billingCycle: BillingCycle,      // 计费周期
    val isActive: Boolean = true,        // 是否激活
    val sortOrder: Int = 0,              // 排序序号
    val createdAt: Instant = Instant.now(),
    val updatedAt: Instant = Instant.now()
)
```

### 2.5 支付记录实体
```kotlin
data class PaymentRecord(
    @Id val id: ObjectId? = null,
    val orderId: ObjectId,               // 订单ID
    val userId: ObjectId,                // 用户ID
    val paymentMethod: PaymentMethod,    // 支付方式
    val amount: BigDecimal,              // 金额
    val currency: String = "CNY",        // 货币
    val paymentId: String,               // 支付平台订单ID
    val status: PaymentStatus,           // 支付状态
    val paymentData: Map<String, Any>? = null, // 支付平台返回数据
    val createdAt: Instant = Instant.now(),
    val updatedAt: Instant = Instant.now()
)
```

### 2.6 枚举定义
```kotlin
enum class MembershipType {
    FREE,           // 免费用户
    BASIC,          // 基础会员
    PREMIUM,        // 高级会员
    ENTERPRISE      // 企业会员
}

enum class MembershipLevel {
    BASIC,          // 基础
    STANDARD,       // 标准
    ADVANCED,       // 高级
    ENTERPRISE      // 企业
}

enum class SubscriptionPlanType {
    MONTHLY,        // 月付
    QUARTERLY,      // 季付
    YEARLY,         // 年付
    LIFETIME        // 终身
}

enum class SubscriptionStatus {
    ACTIVE,         // 活跃
    PENDING,        // 待激活
    EXPIRED,        // 已过期
    CANCELLED,      // 已取消
    SUSPENDED       // 已暂停
}

enum class BillingCycle {
    MONTHLY,        // 月付
    QUARTERLY,      // 季付
    YEARLY          // 年付
}

enum class PaymentMethod {
    WECHAT_PAY,     // 微信支付
    ALIPAY,         // 支付宝
    CREDIT_CARD,    // 信用卡
    APPLE_PAY       // Apple Pay
}

enum class OrderStatus {
    PENDING,        // 待支付
    COMPLETED,      // 已完成
    CANCELLED,      // 已取消
    EXPIRED         // 已过期
}

enum class PaymentStatus {
    PENDING,        // 待支付
    SUCCESS,        // 支付成功
    FAILED,         // 支付失败
    REFUNDED        // 已退款
}

enum class MembershipBenefit {
    UNLIMITED_PROMPTS,      // 无限Prompt数量
    ADVANCED_TEMPLATES,     // 高级模板
    CUSTOM_FOLDERS,         // 自定义文件夹
    PRIORITY_SUPPORT,       // 优先支持
    EXPORT_FEATURES,        // 导出功能
    TEAM_COLLABORATION,     // 团队协作
    API_ACCESS,             // API访问权限
    ADVANCED_ANALYTICS,     // 高级分析
    CUSTOM_BRANDING,        // 自定义品牌
    DEDICATED_ACCOUNT_MANAGER // 专属客户经理
}
```

## 3. API接口设计

### 3.1 会员管理接口

#### 3.1.1 获取会员信息
**GET** `/memberships/me`

**响应：**
```json
{
  "success": true,
  "data": {
    "membership": {
      "id": "membership_id",
      "membershipType": "PREMIUM",
      "level": "ADVANCED",
      "benefits": [
        "UNLIMITED_PROMPTS",
        "ADVANCED_TEMPLATES",
        "CUSTOM_FOLDERS"
      ],
      "expiresAt": "2024-12-31T23:59:59Z",
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  },
  "message": "获取会员信息成功"
}
```

#### 3.1.2 获取会员权益详情
**GET** `/memberships/benefits`

**响应：**
```json
{
  "success": true,
  "data": {
    "benefits": [
      {
        "code": "UNLIMITED_PROMPTS",
        "name": "无限Prompt数量",
        "description": "可以创建无限数量的Prompt",
        "icon": "icon-unlimited",
        "enabled": true
      },
      {
        "code": "ADVANCED_TEMPLATES",
        "name": "高级模板",
        "description": "访问高级Prompt模板库",
        "icon": "icon-templates",
        "enabled": true
      }
    ]
  },
  "message": "获取会员权益成功"
}
```

### 3.2 套餐管理接口

#### 3.2.1 获取套餐列表
**GET** `/plans`

**查询参数：**
- `membershipType`：会员类型筛选
- `billingCycle`：计费周期筛选
- `isActive`：是否激活

**响应：**
```json
{
  "success": true,
  "data": {
    "plans": [
      {
        "id": "plan_id",
        "name": "高级会员月付",
        "description": "高级会员月付套餐",
        "planType": "MONTHLY",
        "membershipType": "PREMIUM",
        "membershipLevel": "ADVANCED",
        "benefits": [
          "UNLIMITED_PROMPTS",
          "ADVANCED_TEMPLATES",
          "CUSTOM_FOLDERS"
        ],
        "amount": 29.90,
        "currency": "CNY",
        "billingCycle": "MONTHLY",
        "isActive": true
      }
    ]
  },
  "message": "获取套餐列表成功"
}
```

#### 3.2.2 获取套餐详情
**GET** `/plans/{id}`

**响应：**
```json
{
  "success": true,
  "data": {
    "plan": {
      "id": "plan_id",
      "name": "高级会员月付",
      "description": "高级会员月付套餐",
      "planType": "MONTHLY",
      "membershipType": "PREMIUM",
      "membershipLevel": "ADVANCED",
      "benefits": [
        "UNLIMITED_PROMPTS",
        "ADVANCED_TEMPLATES",
        "CUSTOM_FOLDERS"
      ],
      "amount": 29.90,
      "currency": "CNY",
      "billingCycle": "MONTHLY",
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  },
  "message": "获取套餐详情成功"
}
```

### 3.3 订单管理接口

#### 3.3.1 创建订单
**POST** `/orders`

**请求体：**
```json
{
  "planId": "plan_id",
  "paymentMethod": "WECHAT_PAY"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "order": {
      "id": "order_id",
      "orderNumber": "ORDER202401010001",
      "planId": "plan_id",
      "planType": "MONTHLY",
      "amount": 29.90,
      "currency": "CNY",
      "status": "PENDING",
      "paymentMethod": "WECHAT_PAY",
      "paymentStatus": "PENDING",
      "expiresAt": "2024-01-02T00:00:00Z",
      "createdAt": "2024-01-01T00:00:00Z"
    },
    "paymentData": {
      "wechatPay": {
        "appId": "wx1234567890",
        "timeStamp": "1704067200",
        "nonceStr": "random_string",
        "package": "prepay_id=wx20240101000000",
        "signType": "MD5",
        "paySign": "signature"
      }
    }
  },
  "message": "订单创建成功"
}
```

#### 3.3.2 获取订单详情
**GET** `/orders/{id}`

**响应：**
```json
{
  "success": true,
  "data": {
    "order": {
      "id": "order_id",
      "orderNumber": "ORDER202401010001",
      "planId": "plan_id",
      "planType": "MONTHLY",
      "amount": 29.90,
      "currency": "CNY",
      "status": "COMPLETED",
      "paymentMethod": "WECHAT_PAY",
      "paymentStatus": "SUCCESS",
      "paymentId": "wx20240101000000",
      "createdAt": "2024-01-01T00:00:00Z",
      "updatedAt": "2024-01-01T00:05:00Z"
    }
  },
  "message": "获取订单详情成功"
}
```

#### 3.3.3 获取订单列表
**GET** `/orders`

**查询参数：**
- `page`：页码（默认1）
- `limit`：每页数量（默认10）
- `status`：订单状态筛选

**响应：**
```json
{
  "success": true,
  "data": {
    "orders": [
      {
        "id": "order_id",
        "orderNumber": "ORDER202401010001",
        "planType": "MONTHLY",
        "amount": 29.90,
        "currency": "CNY",
        "status": "COMPLETED",
        "paymentMethod": "WECHAT_PAY",
        "paymentStatus": "SUCCESS",
        "createdAt": "2024-01-01T00:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 5,
      "pages": 1
    }
  },
  "message": "获取订单列表成功"
}
```

### 3.4 订阅管理接口

#### 3.4.1 获取订阅信息
**GET** `/subscriptions/me`

**响应：**
```json
{
  "success": true,
  "data": {
    "subscription": {
      "id": "subscription_id",
      "planId": "plan_id",
      "planType": "MONTHLY",
      "status": "ACTIVE",
      "billingCycle": "MONTHLY",
      "amount": 29.90,
      "currency": "CNY",
      "startDate": "2024-01-01T00:00:00Z",
      "endDate": "2024-01-31T23:59:59Z",
      "nextBillingDate": "2024-02-01T00:00:00Z",
      "paymentMethod": "WECHAT_PAY",
      "autoRenew": true,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  },
  "message": "获取订阅信息成功"
}
```

#### 3.4.2 取消订阅
**POST** `/subscriptions/cancel`

**请求体：**
```json
{
  "reason": "不再需要此服务"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "subscription": {
      "id": "subscription_id",
      "status": "CANCELLED",
      "endDate": "2024-01-31T23:59:59Z",
      "autoRenew": false
    }
  },
  "message": "订阅取消成功"
}
```

#### 3.4.3 恢复订阅
**POST** `/subscriptions/resume`

**响应：**
```json
{
  "success": true,
  "data": {
    "subscription": {
      "id": "subscription_id",
      "status": "ACTIVE",
      "autoRenew": true
    }
  },
  "message": "订阅恢复成功"
}
```

### 3.5 支付回调接口

#### 3.5.1 微信支付回调
**POST** `/payments/wechat/callback`

**请求体：** 微信支付回调数据

**响应：**
```xml
<xml>
  <return_code><![CDATA[SUCCESS]]></return_code>
  <return_msg><![CDATA[OK]]></return_msg>
</xml>
```

#### 3.5.2 支付宝回调
**POST** `/payments/alipay/callback`

**请求体：** 支付宝回调数据

**响应：**
```json
{
  "success": true
}
```

## 4. 服务配置

### 4.1 Spring Boot配置
```yaml
spring:
  application:
    name: membership-service
  data:
    mongodb:
      uri: mongodb://localhost:27017/membership_db
      auto-index-creation: true
  redis:
    host: localhost
    port: 6379
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest

server:
  port: 8083

# 支付配置
payment:
  wechat:
    app-id: ${WECHAT_APP_ID}
    mch-id: ${WECHAT_MCH_ID}
    api-key: ${WECHAT_API_KEY}
    notify-url: ${WECHAT_NOTIFY_URL}
  alipay:
    app-id: ${ALIPAY_APP_ID}
    private-key: ${ALIPAY_PRIVATE_KEY}
    public-key: ${ALIPAY_PUBLIC_KEY}
    notify-url: ${ALIPAY_NOTIFY_URL}
```

### 4.2 缓存配置
```kotlin
@Configuration
@EnableCaching
class CacheConfig {
    
    @Bean
    fun cacheManager(redisConnectionFactory: RedisConnectionFactory): RedisCacheManager {
        val config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(30))
            .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(GenericJackson2JsonRedisSerializer()))
        
        return RedisCacheManager.builder(redisConnectionFactory)
            .cacheDefaults(config)
            .build()
    }
}
```

### 4.3 消息队列配置
```kotlin
@Configuration
class RabbitMQConfig {
    
    @Bean
    fun membershipEventsExchange(): TopicExchange {
        return TopicExchange("membership.events.exchange")
    }
    
    @Bean
    fun membershipCreatedQueue(): Queue {
        return Queue("membership.created.queue", true)
    }
    
    @Bean
    fun subscriptionUpdatedQueue(): Queue {
        return Queue("subscription.updated.queue", true)
    }
    
    @Bean
    fun binding(): Binding {
        return BindingBuilder
            .bind(membershipCreatedQueue())
            .to(membershipEventsExchange())
            .with("membership.created")
    }
}
```

## 5. 事件处理

### 5.1 会员创建事件
```kotlin
@Service
class MembershipEventHandler {
    
    @RabbitListener(queues = ["membership.created.queue"])
    fun handleMembershipCreated(event: MembershipCreatedEvent) {
        // 通知其他服务会员状态变更
        userService.updateUserMembership(event.userId, event.membershipType)
        businessService.updateUserLimits(event.userId, event.benefits)
    }
}
```

### 5.2 支付成功事件
```kotlin
@Service
class PaymentEventHandler {
    
    @RabbitListener(queues = ["payment.success.queue"])
    fun handlePaymentSuccess(event: PaymentSuccessEvent) {
        // 更新订单状态
        orderService.updateOrderStatus(event.orderId, OrderStatus.COMPLETED)
        
        // 激活会员
        membershipService.activateMembership(event.userId, event.planId)
        
        // 创建订阅记录
        subscriptionService.createSubscription(event.userId, event.planId)
    }
}
```

## 6. 错误处理

### 6.1 错误响应格式
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述",
    "details": "详细错误信息"
  },
  "data": null
}
```

### 6.2 常见错误码
- `MEMBERSHIP_001`：会员信息不存在
- `MEMBERSHIP_002`：会员已过期
- `ORDER_001`：订单创建失败
- `ORDER_002`：订单不存在
- `PAYMENT_001`：支付失败
- `PAYMENT_002`：支付回调验证失败
- `SUBSCRIPTION_001`：订阅状态异常
- `SUBSCRIPTION_002`：订阅续费失败

## 7. 部署配置

### 7.1 Docker配置
```dockerfile
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY build/libs/membership-service-*.jar app.jar
EXPOSE 8083
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 7.2 环境变量配置
```yaml
# application-docker.yml
spring:
  data:
    mongodb:
      uri: mongodb://mongo:27017/membership_db
  redis:
    host: redis
    port: 6379
  rabbitmq:
    host: rabbitmq
    port: 5672
    username: guest
    password: guest

payment:
  wechat:
    app-id: ${WECHAT_APP_ID}
    mch-id: ${WECHAT_MCH_ID}
    api-key: ${WECHAT_API_KEY}
    notify-url: ${WECHAT_NOTIFY_URL}
  alipay:
    app-id: ${ALIPAY_APP_ID}
    private-key: ${ALIPAY_PRIVATE_KEY}
    public-key: ${ALIPAY_PUBLIC_KEY}
    notify-url: ${ALIPAY_NOTIFY_URL}
```

---
**文档版本**：1.0  
**编制人**：项目经理  
**编制日期**：第1周  
**下次评审**：会员服务实现阶段开始前
