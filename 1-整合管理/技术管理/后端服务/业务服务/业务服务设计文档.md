# 业务服务设计文档

## 1. 服务概述

### 1.1 服务职责
业务服务负责核心业务逻辑处理，包括Prompt管理、标签管理、数据同步和分享服务。

### 1.2 核心功能
- **Prompt管理**：增删改查、搜索、分类
- **标签管理**：标签创建、使用统计
- **数据同步**：多端数据同步处理
- **分享服务**：分享链接生成和管理

### 1.3 技术栈
- **语言**：Kotlin
- **框架**：Spring Boot 3.x + Spring Data MongoDB
- **数据库**：MongoDB
- **消息队列**：RabbitMQ + Spring AMQP
- **缓存**：Redis + Spring Data Redis
- **构建工具**：Gradle
- **文档**：SpringDoc OpenAPI 3

## 2. 数据模型设计

### 2.1 Prompt实体
```kotlin
data class Prompt(
    @Id val id: ObjectId? = null,
    val userId: ObjectId,        // 用户ID（来自用户服务）
    val title: String,
    val content: String,
    val description: String? = null,
    val tags: List<String> = emptyList(),
    val category: PromptCategory = PromptCategory.GENERAL,
    val variables: List<String> = emptyList(),
    val useCount: Int = 0,
    val isPublic: Boolean = false,
    val isFavorite: Boolean = false,
    val createdAt: Instant = Instant.now(),
    val updatedAt: Instant = Instant.now(),
    val lastUsedAt: Instant? = null,
    val isDeleted: Boolean = false
)
```

### 2.2 标签实体
```kotlin
data class Tag(
    @Id val id: ObjectId? = null,
    val userId: ObjectId,
    val name: String,
    val color: String? = null,
    val useCount: Int = 0,
    val createdAt: Instant = Instant.now()
)
```

### 2.3 同步记录实体
```kotlin
data class SyncRecord(
    @Id val id: ObjectId? = null,
    val userId: ObjectId,
    val deviceId: String,
    val deviceType: DeviceType,
    val lastSyncTime: Instant = Instant.now(),
    val syncVersion: Long = 0,
    val pendingChanges: Int = 0
)
```

### 2.4 文件夹实体
```kotlin
data class Folder(
    @Id val id: ObjectId? = null,
    val userId: ObjectId,                // 用户ID
    val name: String,                    // 文件夹名称
    val parentId: ObjectId? = null,      // 父文件夹ID（支持多级文件夹）
    val order: Int = 0,                  // 排序序号
    val color: String? = null,           // 文件夹颜色
    val icon: String? = null,            // 文件夹图标
    val description: String? = null,     // 文件夹描述
    val promptCount: Int = 0,            // 包含的prompt数量
    val isDeleted: Boolean = false,      // 是否删除
    val syncStatus: SyncStatus = SyncStatus.SYNCED, // 同步状态
    val createdAt: Instant = Instant.now(), // 创建时间
    val updatedAt: Instant = Instant.now()  // 更新时间
)
```

### 2.5 分享实体
```kotlin
data class Share(
    @Id val id: ObjectId? = null,
    val userId: ObjectId,
    val promptId: ObjectId,
    val shareToken: String,      // 唯一索引
    val accessCount: Int = 0,
    val expiresAt: Instant? = null,
    val isActive: Boolean = true,
    val createdAt: Instant = Instant.now()
)
```

### 2.6 枚举定义
```kotlin
enum class PromptCategory {
    GENERAL,        // 通用
    WRITING,        // 写作
    PROGRAMMING,    // 编程
    ANALYSIS,       // 分析
    CREATIVE        // 创意
}

enum class DeviceType {
    WEB,            // Web端
    ANDROID         // Android端
}
```

## 3. API接口设计

### 3.1 Prompt管理接口

#### 3.1.1 获取Prompt列表
**GET** `/prompts`

**查询参数：**
- `page`：页码（默认1）
- `limit`：每页数量（默认20）
- `category`：分类筛选
- `tags`：标签筛选（逗号分隔）
- `search`：关键词搜索
- `sort`：排序字段（createdAt/updatedAt/useCount）

**响应：**
```json
{
  "success": true,
  "data": {
    "prompts": [
      {
        "id": "prompt_id",
        "title": "Prompt标题",
        "content": "Prompt内容",
        "description": "描述说明",
        "tags": ["标签1", "标签2"],
        "category": "分类",
        "variables": ["变量1", "变量2"],
        "useCount": 10,
        "isFavorite": false,
        "createdAt": "2024-01-01T00:00:00Z",
        "updatedAt": "2024-01-01T00:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 100,
      "pages": 5
    }
  },
  "message": "获取Prompt列表成功"
}
```

#### 3.1.2 创建Prompt
**POST** `/prompts`

**请求体：**
```json
{
  "title": "Prompt标题",
  "content": "Prompt内容",
  "description": "描述说明",
  "tags": ["标签1", "标签2"],
  "category": "分类",
  "variables": ["变量1", "变量2"]
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "prompt": {
      "id": "prompt_id",
      "title": "Prompt标题",
      "content": "Prompt内容",
      "description": "描述说明",
      "tags": ["标签1", "标签2"],
      "category": "分类",
      "variables": ["变量1", "变量2"],
      "useCount": 0,
      "isFavorite": false,
      "createdAt": "2024-01-01T00:00:00Z",
      "updatedAt": "2024-01-01T00:00:00Z"
    }
  },
  "message": "Prompt创建成功"
}
```

#### 3.1.3 获取单个Prompt
**GET** `/prompts/{id}`

**响应：**
```json
{
  "success": true,
  "data": {
    "prompt": {
      "id": "prompt_id",
      "title": "Prompt标题",
      "content": "Prompt内容",
      "description": "描述说明",
      "tags": ["标签1", "标签2"],
      "category": "分类",
      "variables": ["变量1", "变量2"],
      "useCount": 10,
      "isFavorite": false,
      "createdAt": "2024-01-01T00:00:00Z",
      "updatedAt": "2024-01-01T00:00:00Z"
    }
  },
  "message": "获取Prompt成功"
}
```

#### 3.1.4 更新Prompt
**PUT** `/prompts/{id}`

**请求体：**
```json
{
  "title": "更新后的标题",
  "content": "更新后的内容",
  "description": "更新后的描述",
  "tags": ["新标签1", "新标签2"],
  "category": "新分类",
  "variables": ["新变量1", "新变量2"]
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "prompt": {
      "id": "prompt_id",
      "title": "更新后的标题",
      "content": "更新后的内容",
      "description": "更新后的描述",
      "tags": ["新标签1", "新标签2"],
      "category": "新分类",
      "variables": ["新变量1", "新变量2"],
      "useCount": 10,
      "isFavorite": false,
      "createdAt": "2024-01-01T00:00:00Z",
      "updatedAt": "2024-01-02T00:00:00Z"
    }
  },
  "message": "Prompt更新成功"
}
```

#### 3.1.5 删除Prompt
**DELETE** `/prompts/{id}`

**响应：**
```json
{
  "success": true,
  "data": null,
  "message": "Prompt删除成功"
}
```

#### 3.1.6 标记为收藏
**POST** `/prompts/{id}/favorite`

**响应：**
```json
{
  "success": true,
  "data": {
    "prompt": {
      "id": "prompt_id",
      "isFavorite": true
    }
  },
  "message": "收藏成功"
}
```

#### 3.1.7 记录使用次数
**POST** `/prompts/{id}/use`

**响应：**
```json
{
  "success": true,
  "data": {
    "prompt": {
      "id": "prompt_id",
      "useCount": 11,
      "lastUsedAt": "2024-01-02T00:00:00Z"
    }
  },
  "message": "使用记录更新成功"
}
```

### 3.2 标签管理接口

#### 3.2.1 获取标签列表
**GET** `/tags`

**响应：**
```json
{
  "success": true,
  "data": {
    "tags": [
      {
        "id": "tag_id",
        "name": "标签名称",
        "color": "#FF0000",
        "useCount": 5,
        "createdAt": "2024-01-01T00:00:00Z"
      }
    ]
  },
  "message": "获取标签列表成功"
}
```

#### 3.2.2 创建标签
**POST** `/tags`

**请求体：**
```json
{
  "name": "新标签",
  "color": "#FF0000"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "tag": {
      "id": "tag_id",
      "name": "新标签",
      "color": "#FF0000",
      "useCount": 0,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  },
  "message": "标签创建成功"
}
```

### 3.3 数据同步接口

#### 3.3.1 获取同步状态
**GET** `/sync/status`

**响应：**
```json
{
  "success": true,
  "data": {
    "lastSyncTime": "2024-01-01T00:00:00Z",
    "syncVersion": 123,
    "pendingChanges": 0,
    "deviceId": "device_identifier"
  },
  "message": "获取同步状态成功"
}
```

#### 3.3.2 增量同步
**POST** `/sync/incremental`

**请求体：**
```json
{
  "lastSyncTime": "2024-01-01T00:00:00Z",
  "syncVersion": 120,
  "changes": [
    {
      "type": "create|update|delete",
      "resource": "prompts|tags",
      "id": "resource_id",
      "data": { /* 资源数据 */ },
      "timestamp": "2024-01-02T00:00:00Z"
    }
  ]
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "changes": [
      {
        "type": "create|update|delete",
        "resource": "prompts|tags",
        "id": "resource_id",
        "data": { /* 资源数据 */ },
        "timestamp": "2024-01-02T00:00:00Z"
      }
    ],
    "lastSyncTime": "2024-01-02T00:00:00Z",
    "syncVersion": 123
  },
  "message": "同步成功"
}
```

### 3.4 分享接口

#### 3.4.1 创建分享链接
**POST** `/shares`

**请求体：**
```json
{
  "promptId": "prompt_id",
  "expiresAt": "2024-01-31T00:00:00Z"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "share": {
      "id": "share_id",
      "shareToken": "unique_token",
      "promptId": "prompt_id",
      "expiresAt": "2024-01-31T00:00:00Z",
      "accessCount": 0,
      "createdAt": "2024-01-01T00:00:00Z"
    },
    "shareUrl": "https://promptmanager.com/share/unique_token"
  },
  "message": "分享链接创建成功"
}
```

#### 3.4.2 获取分享内容
**GET** `/shares/{token}`

**响应：**
```json
{
  "success": true,
  "data": {
    "prompt": {
      "title": "Prompt标题",
      "content": "Prompt内容",
      "description": "描述说明",
      "tags": ["标签1", "标签2"],
      "category": "分类",
      "variables": ["变量1", "变量2"]
    },
    "share": {
      "accessCount": 1,
      "expiresAt": "2024-01-31T00:00:00Z"
    }
  },
  "message": "获取分享内容成功"
}
```

## 4. 服务配置

### 4.1 Spring Boot配置
```yaml
spring:
  application:
    name: business-service
  data:
    mongodb:
      uri: mongodb://localhost:27017/business_db
      auto-index-creation: true
  redis:
    host: localhost
    port: 6379
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest

server:
  port: 8082
```

### 4.2 消息队列配置
```kotlin
@Configuration
class RabbitMQConfig {
    
    @Bean
    fun userEventsExchange(): TopicExchange {
        return TopicExchange("user.events.exchange")
    }
    
    @Bean
    fun userRegisteredQueue(): Queue {
        return Queue("user.registered.queue", true)
    }
    
    @Bean
    fun binding(): Binding {
        return BindingBuilder
            .bind(userRegisteredQueue())
            .to(userEventsExchange())
            .with("user.registered")
    }
}
```

### 4.3 缓存配置
```kotlin
@Configuration
@EnableCaching
class CacheConfig {
    
    @Bean
    fun cacheManager(redisConnectionFactory: RedisConnectionFactory): RedisCacheManager {
        val config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(30))
            .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(GenericJackson2JsonRedisSerializer()))
        
        return RedisCacheManager.builder(redisConnectionFactory)
            .cacheDefaults(config)
            .build()
    }
}
```

## 5. 事件处理

### 5.1 用户注册事件处理
```kotlin
@Service
class UserEventHandler {
    
    @RabbitListener(queues = ["user.registered.queue"])
    fun handleUserRegistered(event: UserRegisteredEvent) {
        // 在业务服务中创建用户概要信息
        userProfileService.createUserProfile(
            userId = event.userId,
            email = event.email,
            username = event.username
        )
    }
}
```

### 5.2 Prompt创建事件发布
```kotlin
@Service
class PromptEventPublisher(
    private val rabbitTemplate: RabbitTemplate
) {
    fun publishPromptCreated(promptId: String, userId: String) {
        val event = PromptCreatedEvent(
            promptId = promptId,
            userId = userId,
            title = "Prompt标题"
        )
        rabbitTemplate.convertAndSend(
            "prompt.events.exchange",
            "prompt.created",
            event
        )
    }
}
```

## 6. 错误处理

### 6.1 错误响应格式
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述",
    "details": "详细错误信息"
  },
  "data": null
}
```

### 6.2 常见错误码
- `VALIDATION_001`：参数验证失败
- `NOT_FOUND_001`：资源不存在
- `PERMISSION_001`：权限不足
- `SYNC_001`：同步冲突
- `SHARE_001`：分享链接无效

## 7. 部署配置

### 7.1 Docker配置
```dockerfile
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY build/libs/business-service-*.jar app.jar
EXPOSE 8082
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 7.2 环境变量配置
```yaml
# application-docker.yml
spring:
  data:
    mongodb:
      uri: mongodb://mongo:27017/business_db
  redis:
    host: redis
    port: 6379
  rabbitmq:
    host: rabbitmq
    port: 5672
    username: guest
    password: guest

server:
  port: 8082
```

---
**文档版本**：1.0  
**编制人**：项目经理  
**编制日期**：第1周  
**下次评审**：业务服务实现阶段开始前
