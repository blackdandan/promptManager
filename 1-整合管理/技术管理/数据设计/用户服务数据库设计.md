# 用户服务数据库设计

## 1. 数据库概述

### 1.1 数据库选择
- **主数据库**：MongoDB（文档型数据库，适合用户数据）
- **缓存数据库**：Redis（会话和令牌缓存）
- **数据库名称**：`user_db`

### 1.2 设计原则
- **用户数据隔离**：用户服务拥有独立的数据库
- **扩展性**：支持用户量增长
- **性能**：关键查询建立索引
- **安全性**：敏感数据加密存储

## 2. 数据模型设计

### 2.1 用户集合 (users)

#### 2.1.1 集合结构
```kotlin
// Kotlin实体类
data class User(
    @Id val id: ObjectId? = null,
    val email: String? = null,           // 邮箱（可为空，用于三方登录）
    val password: String? = null,        // bcrypt加密（可为空，用于三方登录）
    val username: String? = null,        // 用户名
    val avatar: String? = null,          // 头像URL
    val userType: UserType = UserType.REGISTERED, // 用户类型
    val status: UserStatus = UserStatus.ACTIVE,   // 用户状态
    val roles: List<String> = listOf("USER"),     // 用户角色
    val createdAt: Instant = Instant.now(),       // 创建时间
    val updatedAt: Instant = Instant.now(),       // 更新时间
    val lastLogin: Instant? = null,               // 最后登录时间
    val emailVerified: Boolean = false,           // 邮箱验证状态
    val profile: UserProfile? = null              // 用户概要信息
)

// 用户概要信息
data class UserProfile(
    val bio: String? = null,             // 个人简介
    val location: String? = null,        // 位置
    val website: String? = null,         // 个人网站
    val preferences: Map<String, Any> = emptyMap() // 用户偏好设置
)

// 枚举定义
enum class UserType {
    REGISTERED,     // 注册用户
    GUEST,          // 游客
    OAUTH           // 三方登录用户
}

enum class UserStatus {
    ACTIVE,         // 活跃
    INACTIVE,       // 非活跃
    SUSPENDED,      // 暂停
    DELETED         // 已删除
}
```

#### 2.1.2 索引设计
```javascript
// 唯一索引
db.users.createIndex({ "email": 1 }, { unique: true, sparse: true })
db.users.createIndex({ "username": 1 }, { unique: true, sparse: true })

// 复合索引
db.users.createIndex({ "userType": 1, "status": 1 })
db.users.createIndex({ "createdAt": -1 })
db.users.createIndex({ "lastLogin": -1 })
```

### 2.2 三方登录关联集合 (oauth_connections)

#### 2.2.1 集合结构
```kotlin
data class OAuthConnection(
    @Id val id: ObjectId? = null,
    val userId: ObjectId,                // 用户ID
    val provider: OAuthProvider,         // 三方登录提供商
    val providerUserId: String,          // 三方平台的用户ID
    val accessToken: String? = null,     // 访问令牌
    val refreshToken: String? = null,    // 刷新令牌
    val expiresAt: Instant? = null,      // 令牌过期时间
    val profileData: Map<String, Any>? = null, // 三方平台返回的用户信息
    val createdAt: Instant = Instant.now(),
    val updatedAt: Instant = Instant.now()
)

enum class OAuthProvider {
    GITHUB,         // GitHub登录
    GOOGLE,         // Google登录
    WECHAT,         // 微信登录
    APPLE           // Apple登录
}
```

#### 2.2.2 索引设计
```javascript
// 唯一索引：一个用户在一个提供商只能有一个关联
db.oauth_connections.createIndex(
    { "userId": 1, "provider": 1 }, 
    { unique: true }
)

// 提供商用户ID索引
db.oauth_connections.createIndex({ "provider": 1, "providerUserId": 1 })

// 用户ID索引
db.oauth_connections.createIndex({ "userId": 1 })
```

### 2.3 用户会话集合 (user_sessions)

#### 2.3.1 集合结构
```kotlin
data class UserSession(
    @Id val id: ObjectId? = null,
    val userId: ObjectId,                // 用户ID
    val token: String,                   // JWT token
    val refreshToken: String,            // 刷新token
    val expiresAt: Instant,              // 过期时间
    val deviceInfo: DeviceInfo,          // 设备信息
    val ipAddress: String? = null,       // IP地址
    val userAgent: String? = null,       // 用户代理
    val createdAt: Instant = Instant.now()
)

data class DeviceInfo(
    val deviceId: String,                // 设备标识
    val deviceType: DeviceType,          // 设备类型
    val os: String? = null,              // 操作系统
    val browser: String? = null,         // 浏览器
    val appVersion: String? = null       // 应用版本
)

enum class DeviceType {
    WEB,            // Web端
    ANDROID,        // Android端
    IOS             // iOS端
}
```

#### 2.3.2 索引设计
```javascript
// Token索引
db.user_sessions.createIndex({ "token": 1 }, { unique: true })
db.user_sessions.createIndex({ "refreshToken": 1 }, { unique: true })

// 用户ID和过期时间索引
db.user_sessions.createIndex({ "userId": 1, "expiresAt": 1 })

// 设备信息索引
db.user_sessions.createIndex({ "deviceInfo.deviceId": 1 })

// TTL索引：自动清理过期会话
db.user_sessions.createIndex({ "expiresAt": 1 }, { expireAfterSeconds: 0 })
```

### 2.4 游客会话集合 (guest_sessions)

#### 2.4.1 集合结构
```kotlin
data class GuestSession(
    @Id val id: ObjectId? = null,
    val guestId: String,                 // 游客唯一标识
    val deviceId: String,                // 设备标识
    val token: String,                   // JWT token
    val expiresAt: Instant,              // 过期时间
    val createdAt: Instant = Instant.now(),
    val lastActivityAt: Instant = Instant.now() // 最后活动时间
)
```

#### 2.4.2 索引设计
```javascript
// Token索引
db.guest_sessions.createIndex({ "token": 1 }, { unique: true })

// 游客ID和设备ID索引
db.guest_sessions.createIndex({ "guestId": 1, "deviceId": 1 })

// TTL索引：自动清理过期会话（7天）
db.guest_sessions.createIndex({ "expiresAt": 1 }, { expireAfterSeconds: 0 })
```

## 3. Redis缓存设计

### 3.1 缓存键设计
```kotlin
// 用户信息缓存
val USER_CACHE_KEY = "user:${userId}"

// 会话缓存
val SESSION_CACHE_KEY = "session:${token}"

// 限流缓存
val RATE_LIMIT_KEY = "rate_limit:${userId}"

// 验证码缓存
val VERIFICATION_CODE_KEY = "verification:${email}"
```

### 3.2 缓存配置
```yaml
# Redis配置
spring:
  redis:
    host: localhost
    port: 6379
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 8
        max-wait: -1ms
        max-idle: 8
        min-idle: 0

# 缓存配置
cache:
  user:
    ttl: 30m        # 用户信息缓存30分钟
  session:
    ttl: 24h        # 会话缓存24小时
  rate-limit:
    ttl: 1m         # 限流缓存1分钟
```

## 4. 数据迁移策略

### 4.1 游客升级为注册用户
```kotlin
// 数据迁移流程
suspend fun upgradeGuestToUser(
    guestId: String, 
    userData: RegisterRequest
): User {
    // 1. 创建新用户
    val user = createUser(userData)
    
    // 2. 迁移游客数据（通过消息队列）
    eventPublisher.publishGuestUpgraded(guestId, user.id.toString())
    
    // 3. 清理游客会话
    guestSessionRepository.deleteByGuestId(guestId)
    
    return user
}
```

### 4.2 三方登录数据同步
```kotlin
// 三方登录数据同步
suspend fun syncOAuthProfile(
    userId: ObjectId,
    provider: OAuthProvider,
    profileData: Map<String, Any>
) {
    // 更新用户概要信息
    userRepository.updateProfile(userId, profileData)
    
    // 更新三方登录关联
    oauthConnectionRepository.updateProfileData(userId, provider, profileData)
}
```

## 5. 数据安全

### 5.1 敏感数据加密
```kotlin
// 密码加密
fun encryptPassword(password: String): String {
    return BCrypt.hashpw(password, BCrypt.gensalt())
}

// 令牌加密存储
fun encryptToken(token: String): String {
    return encryptionService.encrypt(token)
}
```

### 5.2 数据访问控制
```kotlin
// 数据访问权限检查
suspend fun checkUserAccess(userId: ObjectId, targetUserId: ObjectId) {
    if (userId != targetUserId) {
        throw AccessDeniedException("无权访问该用户数据")
    }
}
```

---
**文档版本**：1.0  
**编制人**：项目经理  
**编制日期**：第1周  
**下次评审**：用户服务数据库实现阶段开始前
